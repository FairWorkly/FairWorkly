#!/bin/bash
# Pre-commit hook: format staged .cs files with CSharpier

STAGED_CS=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$')
if [ -z "$STAGED_CS" ]; then
    exit 0
fi

# Collect backend-relative paths
FILES=()
for file in $STAGED_CS; do
    relative="${file#backend/}"
    if [ "$relative" != "$file" ]; then
        FILES+=("$relative")
    fi
done

if [ ${#FILES[@]} -eq 0 ]; then
    exit 0
fi

# Check CSharpier availability
if ! (cd backend && dotnet csharpier --version) &>/dev/null; then
    echo "[pre-commit] CSharpier not found. Run: cd backend && dotnet tool restore"
    exit 0
fi

# Format all files in one call
if ! (cd backend && dotnet csharpier format "${FILES[@]}"); then
    echo "[pre-commit] CSharpier formatting failed. Please fix errors and retry."
    exit 1
fi

# Re-stage formatted files
for file in $STAGED_CS; do
    git add "$file"
done
